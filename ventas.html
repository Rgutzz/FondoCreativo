<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Ventas Fondo Creativo</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 30px;
}

.dashboard {
    max-width: 1200px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.cards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: space-between;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    flex: 1 1 200px;
    min-width: 180px;
    text-align: center;
}

.card h3 {
    margin: 0;
    font-size: 18px;
    color: #555;
}

.card p {
    font-size: 22px;
    font-weight: bold;
    margin: 10px 0 0;
}

.filters {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.filters select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}

.charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
}

canvas {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    max-height: 400px;
}

.table-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
</style>
</head>
<body>

<h1>Dashboard Ventas Fondo Creativo</h1>

<div class="dashboard">

    <!-- Resumen tarjetas -->
    <div class="cards" id="cardsResumen">
        <!-- Dinámico -->
    </div>

    <!-- Filtros -->
    <div class="filters">
        <select id="filterMes">
            <option value="all">Todos los meses</option>
        </select>

        <select id="filterAno">
            <option value="all">Todos los años</option>
        </select>

        <select id="filterTipologia">
            <option value="all">Todas las tipologías</option>
        </select>

        <select id="filterMedio">
            <option value="all">Todos los medios</option>
        </select>
    </div>

    <!-- Gráficos -->
    <div class="charts">
        <canvas id="chartVentasMes"></canvas>
        <canvas id="chartTopArticulos"></canvas>
        <canvas id="chartMedioVenta"></canvas>
    </div>

    <!-- Tabla detalle -->
    <div class="table-container">
        <table id="tablaDetalle" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Código</th>
                    <th>Artículo</th>
                    <th>Tipología</th>
                    <th>Tamaño</th>
                    <th>Cantidad</th>
                    <th>Precio Final</th>
                    <th>Medio de venta</th>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>DNI/RUC</th>
                    <th>Teléfono</th>
                    <th>Dirección</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
const API_GET = "/.netlify/functions/getVentas";
let datosGlobal = [];

// Formatear monto
function formatMoney(n) {
    return "S/. " + parseFloat(n || 0).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2});
}

// Llenar filtros
function llenarFiltros() {
    const meses = [...new Set(datosGlobal.map(d=>d.MES).filter(m=>m))].sort((a,b)=>a-b);
    const anos = [...new Set(datosGlobal.map(d=>d.AÑO).filter(a=>a))].sort((a,b)=>a-b);
    const tipologias = [...new Set(datosGlobal.map(d=>d.TIPOLOGIA).filter(t=>t))].sort();
    const medios = [...new Set(datosGlobal.map(d=>d.MEDIO_DE_VENTA).filter(m=>m))].sort();

    meses.forEach(m=> document.getElementById("filterMes").innerHTML += `<option value="${m}">${m}</option>`);
    anos.forEach(a=> document.getElementById("filterAno").innerHTML += `<option value="${a}">${a}</option>`);
    tipologias.forEach(t=> document.getElementById("filterTipologia").innerHTML += `<option value="${t}">${t}</option>`);
    medios.forEach(m=> document.getElementById("filterMedio").innerHTML += `<option value="${m}">${m}</option>`);
}

// Filtrar datos
function filtrarDatos() {
    const mes = document.getElementById("filterMes").value;
    const ano = document.getElementById("filterAno").value;
    const tip = document.getElementById("filterTipologia").value;
    const medio = document.getElementById("filterMedio").value;

    return datosGlobal.filter(d => 
        (mes==="all" || d.MES===mes) &&
        (ano==="all" || d.AÑO===ano) &&
        (tip==="all" || d.TIPOLOGIA===tip) &&
        (medio==="all" || d.MEDIO_DE_VENTA===medio)
    );
}

// Crear resumen
function renderResumen(datos) {
    const cont = document.getElementById("cardsResumen");
    cont.innerHTML = "";

    const totalVentas = datos.reduce((sum,d)=>sum+parseFloat(d["PRECIO FINAL"]||0),0);
    const totalCantidad = datos.reduce((sum,d)=>sum+parseFloat(d.CANTIDAD||0),0);
    const pedidosUnicos = [...new Set(datos.map(d=>d.PEDIDO))].length;
    const promedioPorPedido = pedidosUnicos ? totalVentas/pedidosUnicos : 0;

    const cards = [
        {title:"Ventas totales", value:formatMoney(totalVentas)},
        {title:"Cantidad vendida", value:totalCantidad},
        {title:"Pedidos únicos", value:pedidosUnicos},
        {title:"Promedio por pedido", value:formatMoney(promedioPorPedido)}
    ];

    cards.forEach(c=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h3>${c.title}</h3><p>${c.value}</p>`;
        cont.appendChild(div);
    });
}

// Crear gráficos
let chartVentasMes;

function renderGraficos(datos) {
    // Ventas por mes
    const ventasMes = {};
    datos.forEach(d=>{
        const key = `${d.MES}-${d.AÑO}`;
        ventasMes[key] = (ventasMes[key]||0) + parseFloat(d["PRECIO FINAL"]||0);
    });
    const labelsMes = Object.keys(ventasMes).sort((a,b)=>{
        const [ma,aa] = a.split("-").map(Number);
        const [mb,ab] = b.split("-").map(Number);
        return aa - ab || ma - mb;
    });
    const dataMes = labelsMes.map(l=>ventasMes[l]);

    if(chartVentasMes) chartVentasMes.destroy();
    const ctx1 = document.getElementById("chartVentasMes").getContext("2d");
    chartVentasMes = new Chart(ctx1,{
        type:"bar",
        data:{labels:labelsMes,datasets:[{label:"Ventas por mes",data:dataMes,backgroundColor:"#4e73df"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
        }

// Orden natural de pedidos
function sortPedidos(a,b){
    const regex = /^([A-Z]+)-(\d+)$/;
    const ma = a.PEDIDO.match(regex);
    const mb = b.PEDIDO.match(regex);
    if(ma && mb){
        const prefixCmp = ma[1].localeCompare(mb[1]);
        if(prefixCmp !== 0) return prefixCmp;
        return parseInt(ma[2]) - parseInt(mb[2]);
    }
    return a.PEDIDO.localeCompare(b.PEDIDO);
}

// Tabla
let tablaDetalle;
function renderTabla(datos) {
    const tbody = $("#tablaDetalle tbody");
    tbody.empty();

    const sorted = [...datos].sort(sortPedidos);

    sorted.forEach(d=>{
        tbody.append(`
            <tr>
                <td>${d.PEDIDO}</td>
                <td>${d.CODIGO}</td>
                <td>${d.ARTICULO}</td>
                <td>${d.TIPOLOGIA}</td>
                <td>${d.TAMAÑO}</td>
                <td>${d.CANTIDAD}</td>
                <td>${formatMoney(d["PRECIO FINAL"])}</td>
                <td>${d.MEDIO_DE_VENTA}</td>
                <td>${d["FECHA VENTA"]}</td>
                <td>${d.NOMBRE}</td>
                <td>${d["DNI/RUC"]}</td>
                <td>${d.Telefono}</td>
                <td>${d.Dirección}</td>
            </tr>
        `);
    });

    if($.fn.DataTable.isDataTable("#tablaDetalle")){
        tablaDetalle.destroy();
    }
    tablaDetalle = $("#tablaDetalle").DataTable({responsive:true, pageLength:10});
}

// Cargar datos y render
async function cargarDashboard() {
    const res = await fetch(API_GET);
    datosGlobal = await res.json();

    llenarFiltros();
    actualizarDashboard();
}

// Actualizar según filtros
function actualizarDashboard() {
    const filtrados = filtrarDatos();
    renderResumen(filtrados);
    renderGraficos(filtrados);
    renderTabla(filtrados);
}

// Eventos filtros
document.querySelectorAll(".filters select").forEach(sel=>{
    sel.addEventListener("change", actualizarDashboard);
});

// Inicializar
document.addEventListener("DOMContentLoaded", cargarDashboard);
</script>
</body>
</html>
