<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Ventas Fondo Creativo</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
h1 { text-align: center; margin-bottom: 30px; }
.dashboard { max-width: 1200px; margin: auto; display: flex; flex-direction: column; gap: 30px; }
.cards { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1 1 200px; min-width: 180px; text-align: center; }
.card h3 { margin: 0; font-size: 18px; color: #555; }
.card p { font-size: 22px; font-weight: bold; margin: 10px 0 0; }
.filters { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
.filters select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
.charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
canvas { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
.table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
</style>
</head>
<body>

<h1>Dashboard Ventas Fondo Creativo</h1>

<div class="dashboard">

    <!-- Resumen tarjetas -->
    <div class="cards" id="cardsResumen"></div>

    <!-- Filtros -->
    <div class="filters">
        <select id="filterMes"><option value="all">Todos los meses</option></select>
        <select id="filterAno"><option value="all">Todos los años</option></select>
        <select id="filterTipologia"><option value="all">Todas las tipologías</option></select>
        <select id="filterMedio"><option value="all">Todos los medios</option></select>
    </div>

    <!-- Gráficos -->
    <div class="charts">
        <canvas id="chartVentasMes"></canvas>
        <canvas id="chartTopArticulos"></canvas>
        <canvas id="chartMedioVenta"></canvas>
        <canvas id="chartDescuentos"></canvas>
        <canvas id="chartTopPedidos"></canvas>
    </div>

    <!-- Tabla detalle -->
    <div class="table-container">
        <table id="tablaDetalle" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Código</th>
                    <th>Artículo</th>
                    <th>Tipología</th>
                    <th>Tamaño</th>
                    <th>Cantidad</th>
                    <th>Precio Final</th>
                    <th>Descuento S/.</th>
                    <th>Medio de venta</th>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>DNI/RUC</th>
                    <th>Teléfono</th>
                    <th>Dirección</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
const API_GET = "/.netlify/functions/getVentas";
let datosGlobal = [];

// ---------- UTILIDADES ----------
function limpiarNumero(str){
    if(!str) return 0;
    return parseFloat(str.toString().replace(/[^\d.-]/g,"")) || 0;
}
function formatMoney(num){ return "S/. " + limpiarNumero(num).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function numeroPedido(str){ const match = str.match(/-(\d+)$/); return match ? parseInt(match[1]) : 0; }
function formatFechaOrden(str){ if(!str) return ""; const parts = str.split("/"); if(parts.length!==3) return str; return `${parts[2]}-${parts[1].padStart(2,"0")}-${parts[0].padStart(2,"0")}`; }

// ---------- FILTROS ----------
function llenarFiltros() {
    const meses = [...new Set(datosGlobal.map(d=>d.MES).filter(m=>m))].sort((a,b)=>a-b);
    const anos = [...new Set(datosGlobal.map(d=>d.AÑO).filter(a=>a))].sort((a,b)=>a-b);
    const tipologias = [...new Set(datosGlobal.map(d=>d.TIPOLOGIA).filter(t=>t))].sort();
    const medios = [...new Set(datosGlobal.map(d=>d.MEDIO_DE_VENTA).filter(m=>m))].sort();

    const selectMes = document.getElementById("filterMes");
    meses.forEach(m=> selectMes.innerHTML += `<option value="${m}">${m}</option>`);
    const selectAno = document.getElementById("filterAno");
    anos.forEach(a=> selectAno.innerHTML += `<option value="${a}">${a}</option>`);
    const selectTip = document.getElementById("filterTipologia");
    tipologias.forEach(t=> selectTip.innerHTML += `<option value="${t}">${t}</option>`);
    const selectMedio = document.getElementById("filterMedio");
    medios.forEach(m=> selectMedio.innerHTML += `<option value="${m}">${m}</option>`);
}
function filtrarDatos() {
    const mes = document.getElementById("filterMes").value;
    const ano = document.getElementById("filterAno").value;
    const tip = document.getElementById("filterTipologia").value;
    const medio = document.getElementById("filterMedio").value;

    return datosGlobal.filter(d => 
        (mes==="all" || d.MES===mes) &&
        (ano==="all" || d.AÑO===ano) &&
        (tip==="all" || d.TIPOLOGIA===tip) &&
        (medio==="all" || d.MEDIO_DE_VENTA===medio)
    );
}

// ---------- RESUMEN TARJETAS ----------
function renderResumen(datos) {
    const cont = document.getElementById("cardsResumen"); cont.innerHTML="";
    const totalVentas = datos.reduce((sum,d)=>sum+limpiarNumero(d["PRECIO FINAL"]),0);
    const totalCantidad = datos.reduce((sum,d)=>sum+limpiarNumero(d.CANTIDAD),0);
    const pedidosUnicos = [...new Set(datos.map(d=>d.PEDIDO))].length;
    const promedioPorPedido = pedidosUnicos ? totalVentas/pedidosUnicos : 0;
    const totalDescuento = datos.reduce((sum,d)=>sum+limpiarNumero(d["DESCUENTO S/."]),0);

    const cards = [
        {title:"Ventas totales", value:formatMoney(totalVentas)},
        {title:"Cantidad vendida", value:totalCantidad},
        {title:"Pedidos únicos", value:pedidosUnicos},
        {title:"Promedio por pedido", value:formatMoney(promedioPorPedido)},
        {title:"Descuento total", value:formatMoney(totalDescuento)}
    ];
    cards.forEach(c=>{
        const div = document.createElement("div");
        div.className="card";
        div.innerHTML=`<h3>${c.title}</h3><p>${c.value}</p>`;
        cont.appendChild(div);
    });
}

// ---------- GRÁFICOS ----------
let chartVentasMes, chartTopArticulos, chartMedioVenta, chartDescuentos, chartTopPedidos;
function renderGraficos(datos) {
    // Ventas por mes
    const ventasMes={};
    datos.forEach(d=>{ const key=d.MES+"-"+d.AÑO; ventasMes[key]=(ventasMes[key]||0)+limpiarNumero(d["PRECIO FINAL"]); });
    const labelsMes=Object.keys(ventasMes).sort();
    const dataMes=Object.values(ventasMes);
    if(chartVentasMes) chartVentasMes.destroy();
    chartVentasMes = new Chart(document.getElementById("chartVentasMes").getContext("2d"),{
        type:"bar",
        data:{labels:labelsMes,datasets:[{label:"Ventas por mes",data:dataMes,backgroundColor:"#4e73df"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Top artículos
    const topArt={};
    datos.forEach(d=>{ const art=d.ARTICULO; topArt[art]=(topArt[art]||0)+limpiarNumero(d.CANTIDAD); });
    const sortedArt=Object.entries(topArt).sort((a,b)=>b[1]-a[1]).slice(0,10);
    if(chartTopArticulos) chartTopArticulos.destroy();
    chartTopArticulos = new Chart(document.getElementById("chartTopArticulos").getContext("2d"),{
        type:"bar",
        data:{labels:sortedArt.map(e=>e[0]),datasets:[{label:"Cantidad vendida",data:sortedArt.map(e=>e[1]),backgroundColor:"#1cc88a"}]},
        options:{responsive:true,plugins:{legend:{display:false}},indexAxis:"y",scales:{x:{beginAtZero:true}}}
    });

    // Medio de venta
    const medios={};
    datos.forEach(d=>{ const m=d.MEDIO_DE_VENTA; medios[m]=(medios[m]||0)+limpiarNumero(d["PRECIO FINAL"]); });
    if(chartMedioVenta) chartMedioVenta.destroy();
    chartMedioVenta = new Chart(document.getElementById("chartMedioVenta").getContext("2d"),{
        type:"doughnut",
        data:{labels:Object.keys(medios),datasets:[{data:Object.values(medios),backgroundColor:["#4e73df","#1cc88a","#f6c23e","#e74a3b"]}]},
        options:{responsive:true,plugins:{legend:{position:"bottom"}}}
    });

    // Descuentos por tipología
    const descuentos={};
    datos.forEach(d=>{ const t=d.TIPOLOGIA; descuentos[t]=(descuentos[t]||0)+limpiarNumero(d["DESCUENTO S/."]); });
    if(chartDescuentos) chartDescuentos.destroy();
    chartDescuentos = new Chart(document.getElementById("chartDescuentos").getContext("2d"),{
        type:"bar",
        data:{labels:Object.keys(descuentos),datasets:[{label:"Descuento S/.",data:Object.values(descuentos),backgroundColor:"#f6c23e"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Top pedidos
    const pedidos={};
    datos.forEach(d=>{ const p=d.PEDIDO; pedidos[p]=(pedidos[p]||0)+limpiarNumero(d["PRECIO FINAL"]); });
    const sortedPedidos=Object.entries(pedidos).sort((a,b)=>numeroPedido(b[0])-numeroPedido(a[0])).slice(0,10);
    if(chartTopPedidos) chartTopPedidos.destroy();
    chartTopPedidos = new Chart(document.getElementById("chartTopPedidos").getContext("2d"),{
        type:"bar",
        data:{labels:sortedPedidos.map(e=>e[0]),datasets:[{label:"Ventas por pedido",data:sortedPedidos.map(e=>e[1]),backgroundColor:"#36b9cc"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
}

// ---------- TABLA ----------
let tablaDetalle;
function renderTabla(datos){
    const tbody=$("#tablaDetalle tbody"); tbody.empty();
    datos.forEach(d=>{
        tbody.append(`<tr>
            <td>${d.PEDIDO}</td>
            <td>${d.CODIGO}</td>
            <td>${d.ARTICULO}</td>
            <td>${d.TIPOLOGIA}</td>
            <td>${d.TAMAÑO}</td>
            <td>${d.CANTIDAD}</td>
            <td>${formatMoney(d["PRECIO FINAL"])}</td>
            <td>${formatMoney(d["DESCUENTO S/."])}</td>
            <td>${d.MEDIO_DE_VENTA}</td>
            <td>${d["FECHA VENTA"]}</td>
            <td>${d.NOMBRE}</td>
            <td>${d["DNI/RUC"]}</td>
            <td>${d.Telefono}</td>
            <td>${d.Dirección}</td>
        </tr>`);
    });
    if($.fn.DataTable.isDataTable("#tablaDetalle")) tablaDetalle.destroy();
    tablaDetalle=$("#tablaDetalle").DataTable({responsive:true,pageLength:10});
}

// ---------- CARGAR DASHBOARD ----------
async function cargarDashboard(){
    const res=await fetch(API_GET);
    datosGlobal=await res.json();
    llenarFiltros();
    actualizarDashboard();
}
function actualizarDashboard(){
    const filtrados=filtrarDatos();
    renderResumen(filtrados);
    renderGraficos(filtrados);
    renderTabla(filtrados);
}
document.querySelectorAll(".filters select").forEach(sel=>{ sel.addEventListener("change", actualizarDashboard); });
document.addEventListener("DOMContentLoaded", cargarDashboard);
</script>

</body>
</html>
