<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedidos Fondo Creativo</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 25px;
}

.contenedor {
    max-width: 1100px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 40px;
}

/* ================================ */
/* CINTA COLOR POR NÚMERO DE PEDIDO */
/* ================================ */
.pedido-banner {
    font-size: 14px;
    font-weight: bold;
    color: white;
    padding: 6px 10px;
    text-align: center;
    border-radius: 10px 10px 0 0;
}

/* GENERADOR DE COLORES SUAVES */
[class*="pedido-color-"] {
    background: #777;
}

.card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.card-img {
    width: 100%;
    height: 380px;
    object-fit: contain;
    background: #e9e9e9;
}

.card-info {
    padding: 12px 15px;
}

/* ================================ */
/* CAMPOS ALINEADOS                 */
/* ================================ */
.info-item {
    display: flex;
    gap: 8px;
    margin: 6px 0;
    font-size: 14px;
}

.info-item.long {
    align-items: flex-start;
}

.label {
    width: 120px;
    font-weight: bold;
    flex-shrink: 0;
}

.value {
    flex: 1;
    line-height: 1.3em;
}

/* BADGES DE ESTADO */
.estado {
    padding: 2px 6px;
    font-size: 11px;
    border-radius: 4px;
    font-weight: bold;
    white-space: nowrap;
}

.verde { background: #5cb85c; color: white; }
.amarillo { background: #f0ad4e; color: black; }
.rojo { background: #d9534f; color: white; }
.gris { background: #777; color: white; }

/* ================================ */
/* LISTA DE PENDIENTES              */
/* ================================ */
.lista-pendientes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 18px;
}

/* ================================ */
/* HISTORIAL MINI TARJETAS          */
/* ================================ */
.lista-historial {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
}

.mini-card {
    background: white;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 12px;
}

.mini-img {
    width: 70px;
    height: 70px;
    object-fit: contain;
    background: #eee;
    border-radius: 5px;
}

.mini-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.mini-label {
    font-weight: bold;
    font-size: 11px;
}

.pedido-mini {
    font-size: 11px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 6px;
    background: #ddd;
    margin-bottom: 4px;
}

.filtro {
    margin-bottom: 10px;
}
</style>
</head>

<body>

<h1>Pedidos Fondo Creativo</h1>

<div class="contenedor">

    <!-- PENDIENTES -->
    <section>
        <h2>Pendientes</h2>
        <div id="pendientesLista" class="lista-pendientes"></div>
    </section>

    <!-- HISTORIAL -->
    <section>
        <h2>Historial</h2>

        <select id="filtroMes" class="filtro">
            <option value="all">Ver todo</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>

        <div id="historialLista" class="lista-historial"></div>
    </section>

</div>

<script>
const API_GET = "/.netlify/functions/getPedidos";

/* COLORES */
function getColorClase(estado, tipo) {
    if (tipo === "CorreoEnviado") {
        if (estado === "CONFIRMADO") return "verde";
        if (estado === "ENVIADO SIN CONFIRMAR") return "amarillo";
        return "rojo";
    }

    if (tipo === "Sublimado" || tipo === "Costura") {
        if (estado === "TERMINADO") return "verde";
        if (estado === "EN PROCESO") return "amarillo";
        return "rojo";
    }

    if (tipo === "Entrega") {
        if (estado === "ENTREGADO") return "verde";
        if (estado === "MOTORIZADO SOLICITADO" || estado === "EN RUTA") return "amarillo";
        if (estado === "ANULADO") return "gris";
        return "rojo";
    }

    return "rojo";
}

/* CARGAR TODO */
let pedidosGlobal = [];

async function cargarPedidos() {
    const res = await fetch(API_GET);
    pedidosGlobal = await res.json();

    const pendientes = pedidosGlobal.filter(p => p.Entrega !== "ENTREGADO" && p.Entrega !== "ANULADO");
    const historial = pedidosGlobal.filter(p => p.Entrega === "ENTREGADO" || p.Entrega === "ANULADO");

    renderPendientes(pendientes);
    renderHistorial(historial);
}

/* =============================== */
/* PENDIENTES                      */
/* =============================== */
function renderPendientes(lista) {
    const cont = document.getElementById("pendientesLista");
    cont.innerHTML = "";

    lista.forEach(p => {
        const hue = (p.NoPedido * 25) % 360;

        const div = document.createElement("div");
        div.className = "card";
        div.style.setProperty("--hue", hue);

        div.innerHTML = `
            <div class="pedido-banner pedido-color-${p.NoPedido}">
                Pedido Nº ${p.NoPedido}
            </div>

            <img src="${p.Imagen}" class="card-img">

            <div class="card-info">

                <div class="info-item">
                    <span class="label">Nombre:</span>
                    <span class="value">${p.Nombre}</span>
                </div>

                <div class="info-item">
                    <span class="label">Agencia:</span>
                    <span class="value">${p.Agencia}</span>
                </div>

                <div class="info-item">
                    <span class="label">Dirección:</span>
                    <span class="value">${p.Direccion}</span>
                </div>

                <div class="info-item long">
                    <span class="label">Especificaciones:</span>
                    <span class="value">${p.Especificaciones}</span>
                </div>

                <div class="info-item">
                    <span class="label">Correo:</span>
                    <span class="value estado ${getColorClase(p.CorreoEnviado,"CorreoEnviado")}">
                        ${p.CorreoEnviado}
                    </span>
                </div>

                <div class="info-item">
                    <span class="label">Sublimado:</span>
                    <span class="value estado ${getColorClase(p.Sublimado,"Sublimado")}">
                        ${p.Sublimado}
                    </span>
                </div>

                <div class="info-item">
                    <span class="label">Costura:</span>
                    <span class="value estado ${getColorClase(p.Costura,"Costura")}">
                        ${p.Costura}
                    </span>
                </div>

                <div class="info-item">
                    <span class="label">Entrega:</span>
                    <span class="value estado ${getColorClase(p.Entrega,"Entrega")}">
                        ${p.Entrega}
                    </span>
                </div>

                <div class="info-item">
                    <span class="label">Fecha Entrega:</span>
                    <span class="value">${p.FechaEntrega}</span>
                </div>

            </div>
        `;

        cont.appendChild(div);
    });
}

/* =============================== */
/* HISTORIAL                       */
/* =============================== */
function normalizarFechaLatina(f) {
    if (!f) return null;
    f = f.trim();
    if (f.includes("/")) {
        const [d,m,a] = f.split("/");
        return `${a}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }
    return f.substring(0,10);
}

function renderHistorial(lista) {
    const cont = document.getElementById("historialLista");
    cont.innerHTML = "";

    const mes = document.getElementById("filtroMes").value;

    const filtrado = lista.filter(p => {
        if (mes === "all") return true;
        if (!p.FechaEntrega) return false;

        const iso = normalizarFechaLatina(p.FechaEntrega);
        if (!iso) return false;

        const fecha = new Date(iso);
        if (isNaN(fecha)) return false;

        return fecha.getMonth() + 1 == mes;
    });

    filtrado.forEach(p => {
        const hue = (p.NoPedido * 25) % 360;

        const div = document.createElement("div");
        div.className = "mini-card";
        div.style.setProperty("--hue", hue);

        div.innerHTML = `
             <img src="${p.Imagen}" class="mini-img">
            <div class="mini-info">
                <div><span class="mini-label">Nombre:</span> ${p.Nombre}</div>
                <div><span class="mini-label">Agencia:</span> ${p.Agencia}</div>
                <div><span class="mini-label">Fecha:</span> ${p.FechaEntrega}</div>
                <div>
                    <span class="estado ${getColorClase(p.Entrega,"Entrega")}">
                        ${p.Entrega}
                    </span>
                </div>
            </div>
        `;

        cont.appendChild(div);
    });
}

document.getElementById("filtroMes").addEventListener("change", () => {
    const historial = pedidosGlobal.filter(
        p => p.Entrega === "ENTREGADO" || p.Entrega === "ANULADO"
    );
    renderHistorial(historial);
});

cargarPedidos();
</script>

</body>
</html>
