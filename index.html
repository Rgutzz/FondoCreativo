<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedidos Fondo Creativo</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        margin-bottom: 25px;
    }

    .contenedor {
        display: flex;
        flex-direction: column;
        gap: 40px;
        max-width: 1100px;
        margin: auto;
    }

    .lista {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 20px;
    }

    .tarjeta {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .tarjeta img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .titulo {
        font-weight: bold;
        margin-top: 6px;
    }

    .estado {
        padding: 4px 8px;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        font-size: 13px;
        display: inline-block;
        margin-bottom: 6px;
    }

    .rojo { background: #d9534f; }
    .amarillo { background: #f0ad4e; }
    .verde { background: #5cb85c; }

    .btn-entregar {
        background: #0275d8;
        color: white;
        width: 100%;
        padding: 10px;
        margin-top: 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 15px;
    }

    .btn-entregar:hover {
        background: #025aa5;
    }

</style>
</head>

<body>

<h1>Pedidos Fondo Creativo</h1>

<div class="contenedor">
    
    <!-- ------------------------- -->
    <!--       PENDIENTES          -->
    <!-- ------------------------- -->
    <section>
        <h2>Pendientes</h2>
        <div id="pendientesLista" class="lista"></div>
    </section>

    <!-- ------------------------- -->
    <!--        ENTREGADOS         -->
    <!-- ------------------------- -->
    <section>
        <h2>Historial Entregados</h2>
        <div id="historialLista" class="lista"></div>
    </section>

</div>

<script>
const API_GET = "/.netlify/functions/getPedidos";
const API_UPDATE = "/.netlify/functions/updatePedido";

// ----------------------
// COLORES DE ESTADOS
// ----------------------
function getColorClase(estado, tipo) {

    if (tipo === "CorreoEnviado") {
        if (estado === "CONFIRMADO") return "verde";
        if (estado === "ENVIADO SIN CONFIRMAR") return "amarillo";
        return "rojo"; // NO HA SIDO ENVIADO
    }

    if (tipo === "Sublimado" || tipo === "Costura") {
        if (estado === "TERMINADO") return "verde";
        if (estado === "EN PROCESO") return "amarillo";
        return "rojo"; // NO CONFIRMADO
    }

    if (tipo === "Entrega") {
        if (estado === "ENTREGADO") return "verde";
        if (estado === "MOTORIZADO SOLICITADO" || estado === "EN RUTA") return "amarillo";
        return "rojo"; // NO ENTREGADO
    }

    return "rojo";
}

// ----------------------
// CARGAR PEDIDOS
// ----------------------
async function cargarPedidos() {
    const res = await fetch(API_GET);
    const data = await res.json();

    const pendientes = data.filter(p => p.Entrega !== "ENTREGADO");
    const entregados = data.filter(p => p.Entrega === "ENTREGADO");

    renderLista(pendientes, document.getElementById("pendientesLista"), true);
    renderLista(entregados, document.getElementById("historialLista"), false);
}

// ----------------------
// RENDER TARJETAS
// ----------------------
function renderLista(lista, contenedor, permitirAccion) {
    contenedor.innerHTML = "";

    lista.forEach(p => {
        const div = document.createElement("div");
        div.className = "tarjeta";

        div.innerHTML = `
            <img src="${p.Imagen}" alt="Imagen del pedido">

            <div class="titulo">Medidas:</div>
            ${p.Ancho} x ${p.Alto} cm

            <div class="titulo">Fecha:</div> ${p.Fecha}

            <div class="titulo">Correo Enviado:</div>
            <span class="estado ${getColorClase(p.CorreoEnviado, "CorreoEnviado")}">
                ${p.CorreoEnviado}
            </span>

            <div class="titulo">Sublimado:</div>
            <span class="estado ${getColorClase(p.Sublimado, "Sublimado")}">
                ${p.Sublimado}
            </span>

            <div class="titulo">Costura:</div>
            <span class="estado ${getColorClase(p.Costura, "Costura")}">
                ${p.Costura}
            </span>

            <div class="titulo">Entrega:</div>
            <span class="estado ${getColorClase(p.Entrega, "Entrega")}">
                ${p.Entrega}
            </span>

            <div class="titulo">Nombre:</div> ${p.Nombre}
            <div class="titulo">Dni:</div> ${p.Dni}
            <div class="titulo">Teléfono:</div> ${p.Telefono}
            <div class="titulo">Dirección:</div> ${p.Direccion}
            <div class="titulo">Agencia:</div> ${p.Agencia}

            <div class="titulo">Especificaciones:</div> ${p.Especificaciones}
            <div class="titulo">Observaciones:</div> ${p.Observaciones}
        `;

        if (permitirAccion) {
            const btn = document.createElement("button");
            btn.className = "btn-entregar";
            btn.textContent = "Marcar como ENTREGADO";

            btn.onclick = async () => {
                await marcarEntregado(p.Id);
                cargarPedidos();
            };

            div.appendChild(btn);
        }

        contenedor.appendChild(div);
    });
}

// ----------------------
// MARCAR COMO ENTREGADO
// ----------------------
async function marcarEntregado(id) {
    const url = `${API_UPDATE}?id=${encodeURIComponent(id)}`;
    await fetch(url);
}

// ----------------------
cargarPedidos();
</script>

</body>
</html>
