<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedidos Fondo Creativo</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

/* ========================================= */
/* =========== OVERLAY DEL PIN ============= */
/* ========================================= */
#pinOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: #f3f3f3;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    z-index: 9999;
    overflow-y: auto;
}

.pin-box {
    background: white;
    width: 90%;
    max-width: 320px;
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
    text-align: center;
}

.pin-input {
    width: 100%;
    text-align: center;
    font-size: 28px;
    padding: 10px 0;
    border: 1px solid #ccc;
    border-radius: 12px;
    margin-bottom: 14px;
}

.pin-btn {
    width: 100%;
    background: #000;
    color: white;
    padding: 10px 0;
    border-radius: 12px;
    font-size: 18px;
    cursor: pointer;
}

.pin-error {
    color: #d9534f;
    font-size: 14px;
    margin-top: 8px;
    display: none;
}

/* ========================================= */
/* =========== TARJETAS NORMALES =========== */
/* ========================================= */

h1 {
    text-align: center;
    margin-bottom: 25px;
}

.contenedor {
    max-width: 1100px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 40px;
}

/* Cinta superior */
.pedido-banner {
    font-size: 14px;
    font-weight: bold;
    color: rgb(255, 255, 255);
    padding: 6px 10px;
    text-align: center;
    border-radius: 10px 10px 0 0;
}

.card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
/* Separaci√≥n lateral para todos los items de informaci√≥n */
.card .info-item {
    padding-left: 10px;
    padding-right: 10px;
}
.card-img {
    width: 100%;
    height: 380px;
    object-fit: contain;
    background: #e9e9e9;
}

.card-info {
    padding: 14px 16px;
}

/* Campos alineados */
.info-item {
    display: flex;
    gap: 8px;
    margin: 8px 0;
    font-size: 14px;
}

.info-item.long .value {
    margin-top: 2px;
}

.label {
    width: 120px;
    font-weight: bold;
    flex-shrink: 0;
}

.value {
    flex: 1;
    line-height: 1.35em;
}

/* Para que los badges NO se estiren dentro del flex */
.value.estado {
    flex: 0 !important;
    width: auto !important;
}


/* BADGES */
.estado {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    white-space: nowrap; /* evita que se rompa en 2 l√≠neas */
    width: auto !important;
    max-width: fit-content;
}

.verde { background: #5cb85c; color: white; }
.amarillo { background: #f0ad4e; color: black; }
.rojo { background: #d9534f; color: white; }
.gris { background: #777; color: white; }
/* Nuevos colores */
.morado { background: #8e44ad; color: white; }     /* morado elegante */
.azul { background: #0275d8; color: white; }        /* azul fuerte */
.celeste { background: #5bc0de; color: black; }     /* celeste suave */
.rosado { background: #ff7eb9; color: black; }      /* rosado pastel */
.fucsia { background: #ff007f; color: white; }      /* fucsia intenso */

/* Pendientes */
.lista-pendientes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 18px;
}

/* Historial */
.lista-historial {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
}

.mini-card {
    background: white;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 12px;
}

.mini-img {
    width: 70px;
    height: 70px;
    object-fit: contain;
    background: #eee;
    border-radius: 5px;
}

.mini-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.mini-label {
    font-weight: bold;
    font-size: 11px;
}

.filtro {
    margin-bottom: 10px;
}
/* ===================== */
/*        MEN√ö TOP       */
/* ===================== */

/* Barra superior que ocupa todo el ancho */
.top-menu-wrapper {
    width: 100%;
    padding: 12px 0;
    display: flex;
    justify-content: center; /* ‚Üê centra el men√∫ */
    border-bottom: 1px solid #334155;
    position: static; /* no flotante */
}

/* Men√∫ centrado dentro de la barra */
.top-menu {
    width: 50%;              /* ‚Üê ocupa solo la mitad */
    max-width: 600px;        /* l√≠mite para pantallas grandes */
    min-width: 260px;        /* para que no se achique demasiado en m√≥viles */
    background: #222;
    color: white;
    padding: 10px 20px;
    border-radius: 12px;
    display: flex;
    justify-content: center; /* centra el contenido */
    align-items: center;
    font-size: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* Estilo de los links */
.top-menu a {
    color: #4db8ff;
    text-decoration: none;
    font-weight: 600;
}

.top-menu a:hover {
    text-decoration: underline;
}

/* Para que el men√∫ no tape nada */
body {
    padding-top: 15px;
}
/* ===================== */
/*       MODAL DETALLE   */
/* ===================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    padding: 20px;
}

.modal-box {
    background: white;
    width: 95%;
    max-width: 480px;
    max-height: 85vh;
    overflow-y: auto;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.25);
    animation: modalFade .25s ease-out;
}

.modal-cerrar {
    font-size: 26px;
    cursor: pointer;
    float: right;
    font-weight: bold;
    color: #444;
}

@keyframes modalFade {
    from { transform: scale(0.93); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}

/* Para que se note que las mini-cards son clickeables */
.mini-card {
    cursor: pointer;
    transition: transform .12s;
}
.mini-card:hover {
    transform: scale(1.02);
}
/* =============== LOADER =============== */
.loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 99999;
}

.loader-box {
    text-align: center;
    font-size: 16px;
    color: #333;
}

/* Spinner */
.spinner {
    width: 45px;
    height: 45px;
    border: 5px solid #ccc;
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
    margin-bottom: 12px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

</style>
</head>

<body>

     <!-- üîµ Loader (VA AQU√ç) -->
    <div id="loader" class="loader-overlay" style="display:none;">
        <div class="loader-box">
            <div class="spinner"></div>
            <p>Cargando pedidos‚Ä¶</p>
        </div>
    </div>

<!-- MEN√ö SUPERIOR (oculto hasta validar PIN) -->
<div class="top-menu-wrapper" id="topMenu" style="display:none;">
    <nav class="top-menu">
        <a href="https://fondocreativo.netlify.app/ventas" style="color:white; text-decoration:none; font-weight:600;">
            Ir a Ventas
        </a>
    </nav>
</div>
<!-- ===================== -->
<!--   PANTALLA DE PIN     -->
<!-- ===================== -->
<div id="pinOverlay">
  <div class="pin-box">
      <h2 class="text-xl font-semibold mb-4">Acceso restringido</h2>

      <p class="text-sm text-gray-600 mb-3">Ingrese su PIN de 4 d√≠gitos</p>

      <input id="pinInput" 
             type="password" 
             maxlength="4"
             inputmode="numeric"
             class="pin-input"
             placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

      <button id="pinBtn" class="pin-btn">
          Acceder
      </button>

      <p id="pinError" class="pin-error">PIN incorrecto</p>
  </div>
</div>



<h1>Pedidos Fondo Creativo</h1>

<div class="contenedor">

    <!-- PENDIENTES DE ENV√çO -->
<section>
    <h2>Pendientes de Env√≠o</h2>
    <div id="envioLista" class="lista-pendientes"></div>
</section>

<!-- EN PROCESO DE PRODUCCI√ìN / EN RUTA -->
<section>
    <h2>En Proceso de Producci√≥n</h2>
    <div id="procesoLista" class="lista-pendientes"></div>
</section>

    <!-- HISTORIAL -->
    <section>
        <h2>Historial</h2>

        <select id="filtroMes" class="filtro">
            <option value="all">Ver todo</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>

        <div id="historialLista" class="lista-historial"></div>
    </section>

</div>

<script>
const API_GET = "/.netlify/functions/getPedidos";

/* COLORES */
function getColorClase(estado, tipo) {
    if (tipo === "CorreoEnviado") {
        if (estado === "CONFIRMADO") return "verde";
        if (estado === "ENVIADO SIN CONFIRMAR") return "amarillo";
        return "rojo";
    }

    if (tipo === "Sublimado" || tipo === "Costura") {
        if (estado === "TERMINADO") return "verde";
        if (estado === "EN PROCESO") return "amarillo";
        return "rojo";
    }

    if (tipo === "Entrega") {
        if (estado === "ENTREGADO") return "verde";
        if (estado === "PRODUCCI√ìN") return "morado";
        if (estado === "SUBLIMADO") return "rosado";
        if (estado === "COSTURA") return "celeste";
        if (estado === "ENVIADO" || estado === "EN RUTA" || estado === "EN DESTINO") return "amarillo";
        if (estado === "ANULADO") return "gris";
        return "rojo";
    }

    return "rojo";
}

/* Cargar pedidos */
let pedidosGlobal = [];

async function cargarPedidos() {
   // üîπ Mostrar loader ANTES de cargar Google Sheets
    document.getElementById("loader").style.display = "flex";
    
    const res = await fetch(API_GET);
    pedidosGlobal = await res.json();

    // Filtrar por grupos
    const pendientesEnvio = pedidosGlobal.filter(
        p => p.Estado === "ALMACEN"
    );

    const enProceso = pedidosGlobal.filter(p =>
        ["PRODUCCI√ìN", "SUBLIMADO", "COSTURA"]
        .includes(p.Estado)
    );

    const historial = pedidosGlobal.filter(
        p => ["ENTREGADO", "ANULADO", "ENVIADO", "EN RUTA", "EN DESTINO"].includes(p.Estado)
    );

    renderPendientesEnvio(pendientesEnvio);
    renderProcesoProduccion(enProceso);
    renderHistorial(historial);
    document.getElementById("loader").style.display = "none";
}
/* Tarjeta HTML reutilizada */
function crearTarjetaPedido(p) {

let img = p.Imagen ? p.Imagen.trim() : "";

    if (img) {
        // Si NO termina en .png, .jpg, .jpeg o .gif ‚Üí agregar .png
        if (!/\.(png|jpg|jpeg|gif)$/i.test(img)) {
            img = img + ".png";
        }
    }
    return `
        <div class="card">
            <div class="pedido-banner" style="background:#3a3a3a;">
                Pedido N¬∫ ${p.NoPedido}
            </div>

            <img src="${img}" class="card-img">

            <div class="info-item">
                <span class="label">Medida:</span>
                <span class="value">Anch. ${p.Ancho} x Alt. ${p.Alto}</span>
            </div>
            <div class="info-item"><span class="label">Fecha Pedido:</span><span class="value">${p.Fecha}</span></div>
            <div class="info-item"><span class="label">Nombre:</span><span class="value">${p.Nombre}</span></div>
            <div class="info-item"><span class="label">DNI/RUC:</span><span class="value">${p.Dni}</span></div>
            <div class="info-item"><span class="label">Telefono:</span><span class="value">${p.Telefono}</span></div>
            <div class="info-item"><span class="label">Agencia:</span><span class="value">${p.Agencia}</span></div>
            <div class="info-item"><span class="label">Direcci√≥n:</span><span class="value">${p.Direccion}</span></div>
            <div class="info-item long"><span class="label">Especif.:</span><span class="value">${p.Especificaciones}</span></div>

            <div class="info-item">
                <span class="label">Estado:</span>
                <span class="value estado ${getColorClase(p.Estado,"Entrega")}">${p.Estado}</span>
            </div>

            <div class="info-item"><span class="label">Observaciones:</span><span class="value">${p.Observaciones}</span></div>
        </div>
    `;
}

/* Render: Pendientes de Env√≠o */
function renderPendientesEnvio(lista) {
    const cont = document.getElementById("envioLista");
    cont.innerHTML = "";
    lista.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = crearTarjetaPedido(p);
        cont.appendChild(div.firstElementChild);
    });
}

/* Render: En Proceso de Producci√≥n / En Ruta */
function renderProcesoProduccion(lista) {
    const cont = document.getElementById("procesoLista");
    cont.innerHTML = "";
    lista.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = crearTarjetaPedido(p);
        cont.appendChild(div.firstElementChild);
    });
}

/* Pendientes */
function renderPendientes(lista) {
    const cont = document.getElementById("pendientesLista");
    cont.innerHTML = "";

    lista.forEach(p => {
    // --- A√ëADIR .png AUTOM√ÅTICO A LA IMAGEN ---
        let img = p.Imagen ? p.Imagen.trim() : "";

        if (img) {
            // Si NO termina en .png, .jpg, .jpeg o .gif ‚Üí agregar .png
            if (!/\.(png|jpg|jpeg|gif)$/i.test(img)) {
                img = img + ".png";
            }
        }
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
            <div class="pedido-banner" style="background:#3a3a3a;">
            Pedido N¬∫ ${p.NoPedido}
             </div>

            <img src="${img}" class="card-img">

            <div class="info-item">
                <span class="label">Medida:</span>
                <span class="value">Anch. ${p.Ancho} x Alt. ${p.Alto}</span>
            </div>
              <div class="info-item"><span class="label">Fecha Pedido:</span><span class="value">${p.Fecha}</span></div>
                <div class="info-item"><span class="label">Nombre:</span><span class="value">${p.Nombre}</span></div>
                <div class="info-item"><span class="label">DNI/RUC:</span><span class="value">${p.Dni}</span></div>
                <div class="info-item"><span class="label">Telefono:</span><span class="value">${p.Telefono}</span></div>
                <div class="info-item"><span class="label">Agencia:</span><span class="value">${p.Agencia}</span></div>

                <div class="info-item"><span class="label">Direcci√≥n:</span><span class="value">${p.Direccion}</span></div>

                
                <div class="info-item long"><span class="label">Especif.:</span><span class="value">${p.Especificaciones}</span></div>

                <div class="info-item"><span class="label">Estado:</span><span class="value estado ${getColorClase(p.Estado,"Entrega")}">${p.Estado}</span></div>
                <div class="info-item"><span class="label">Observaciones:</span><span class="value">${p.Observaciones}</span></div>
            </div>
        `;

        cont.appendChild(div);
    });
}

/* Historial */
function normalizarFechaLatina(f) {
    if (!f) return null;
    f = f.trim();
    if (f.includes("/")) {
        const [d,m,a] = f.split("/");
        return `${a}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }
    return f.substring(0,10);
}

function renderHistorial(lista) {
    const cont = document.getElementById("historialLista");
    cont.innerHTML = "";

    const mes = document.getElementById("filtroMes").value;

    const filtrado = lista.filter(p => {
        if (mes === "all") return true;
        if (!p.Fecha) return false;

        const iso = normalizarFechaLatina(p.Fecha);
        if (!iso) return false;

        const fecha = new Date(iso);
        if (isNaN(fecha)) return false;

        return fecha.getMonth() + 1 == mes;
    });

    filtrado.forEach(p => {
    const div = document.createElement("div");
    div.className = "mini-card";
// === CORRECCI√ìN IMAGEN ===
        let img = p.Imagen ? p.Imagen.trim() : "";
        if (img && !/\.(png|jpg|jpeg|gif)$/i.test(img)) {
            img = img + ".png";
        }

    div.innerHTML = `
        <img src="${img}" class="mini-img">
        <div class="mini-info">
            <div><span class="mini-label">Pedido:</span> ${p.NoPedido}</div>
            <div><span class="mini-label">Nombre:</span> ${p.Nombre}</div>
            <div><span class="mini-label">Agencia:</span> ${p.Agencia}</div>
            <div><span class="mini-label">Fecha Entrega:</span> ${p.FechaEntrega}</div>
            <span class="estado ${getColorClase(p.Estado,"Entrega")}">${p.Estado}</span>
        </div>
    `;

    cont.appendChild(div);
});

// Activar modal con la misma lista filtrada
activarModalHistorial(filtrado);
}

document.getElementById("filtroMes").addEventListener("change", () => {
    const historial = pedidosGlobal.filter(
        p => ["ENTREGADO", "ANULADO", "ENVIADO", "EN RUTA", "EN DESTINO"].includes(p.Estado)
    );
    renderHistorial(historial);
});

// Seleccionar mes actual por defecto
window.addEventListener("DOMContentLoaded", () => {
    const mesActual = new Date().getMonth() + 1; // 1-12
    const filtro = document.getElementById("filtroMes");

    if (filtro.querySelector(`option[value="${mesActual}"]`)) {
        filtro.value = mesActual;
    }

    const historial = pedidosGlobal.filter(
        p => ["ENTREGADO", "ANULADO", "ENVIADO", "EN RUTA", "EN DESTINO"].includes(p.Estado)
    );

    renderHistorial(historial);
});

/* =================== */
/*   L√ìGICA DEL PIN    */
/* =================== */

const PIN_CORRECTO = "0324";
const CADUCIDAD_HORAS = 24;

function validarPIN() {
    const input = document.getElementById("pinInput").value.trim();
    const error = document.getElementById("pinError");

    if (input === PIN_CORRECTO) {
        localStorage.setItem("pin_ok", "true");
        localStorage.setItem("pin_time", Date.now().toString());
        document.getElementById("pinOverlay").style.display = "none";
         // ‚Üê mostrar men√∫
        document.getElementById("topMenu").style.display = "flex";
        // üîµ AHORA reci√©n mostrar loader
        document.getElementById("loader").style.display = "flex";
        error.style.display = "none";
    } else {
        error.style.display = "block";
    }
}

function comprobarPIN() {
    const ok = localStorage.getItem("pin_ok");
    const time = Number(localStorage.getItem("pin_time") || 0);
    const ahora = Date.now();

    if (ok === "true" && time) {
        const horas = (ahora - time) / (1000 * 60 * 60);
        if (horas < CADUCIDAD_HORAS) {
            document.getElementById("pinOverlay").style.display = "none";
            // ‚Üê mostrar men√∫ si el PIN sigue v√°lido
        document.getElementById("topMenu").style.display = "flex";
            return;
        }
    }

    document.getElementById("pinOverlay").style.display = "flex";
}

document.addEventListener("DOMContentLoaded", () => {
    comprobarPIN();

    document.getElementById("pinBtn").addEventListener("click", validarPIN);

    document.getElementById("pinInput").addEventListener("keyup", e => {
        if (e.key === "Enter") validarPIN();
    });

    cargarPedidos();
});

/* =============================== */
/*   ABRIR MODAL CON MINI-CARD    */
/* =============================== */

function activarModalHistorial(listaOriginal) {
    const historialDiv = document.getElementById("historialLista");

    // Evento para cada mini-card
    historialDiv.querySelectorAll(".mini-card").forEach((card, i) => {
        card.addEventListener("click", () => {
            const pedido = listaOriginal[i];

            // Reutilizamos la tarjeta completa existente
            const htmlCompleto = crearTarjetaPedido(pedido);

            document.getElementById("modalContenido").innerHTML = htmlCompleto;
            document.getElementById("modalOverlay").style.display = "flex";
        });
    });
}

// Cerrar tocando afuera
document.getElementById("modalOverlay")?.addEventListener("click", e => {
    if (e.target.id === "modalOverlay") {
        document.getElementById("modalOverlay").style.display = "none";
    }
});
// Asegurar que el bot√≥n de cerrar siempre funcione
document.addEventListener("DOMContentLoaded", () => {
    const modalCerrar = document.getElementById("modalCerrar");
    const modalOverlay = document.getElementById("modalOverlay");

    modalCerrar.addEventListener("click", () => {
        modalOverlay.style.display = "none";
    });

    modalOverlay.addEventListener("click", e => {
        if (e.target.id === "modalOverlay") {
            modalOverlay.style.display = "none";
        }
    });
});

</script>

<!-- MODAL PARA DETALLE DEL PEDIDO -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <span id="modalCerrar" class="modal-cerrar">√ó</span>
        <div id="modalContenido"></div>
    </div>
</div>

</body>
</html>
