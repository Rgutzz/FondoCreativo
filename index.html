<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedidos Fondo Creativo</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 25px;
}

.contenedor {
    max-width: 1100px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 40px;
}

/* ------------------------------- */
/* TARJETAS PENDIENTES (compactas) */
/* ------------------------------- */
.lista-pendientes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 18px;
}

.tarjeta {
    background: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.tarjeta img {
    width: 100%;
    height: 380px;
    object-fit: contain;
    background: #eaeaea;
    border-radius: 6px;
}

.item {
    width: 100%;
    font-size: 13px;
    margin-top: 4px;
}

.titulo {
    font-weight: bold;
    width: 105px;
    display: inline-block;
}

/* ESTADOS */
.estado {
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    border-radius: 5px;
    color: white;
}

.rojo { background: #d9534f; }
.amarillo { background: #f0ad4e; color: black; }
.verde { background: #5cb85c; }
.gris { background: #777; }

/* ------------------------------- */
/* HISTORIAL (mini cards)          */
/* ------------------------------- */
.lista-historial {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
}

.mini-card {
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
}

.mini-img {
    width: 70px;
    height: 70px;
    object-fit: contain;
    background: #eee;
    border-radius: 5px;
}

.mini-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.mini-label {
    font-weight: bold;
    font-size: 11px;
}

.filtro {
    margin-bottom: 10px;
}
</style>
</head>

<body>

<h1>Pedidos Fondo Creativo</h1>

<div class="contenedor">

    <!-- PENDIENTES -->
    <section>
        <h2>Pendientes</h2>
        <div id="pendientesLista" class="lista-pendientes"></div>
    </section>

    <!-- HISTORIAL -->
    <section>
        <h2>Historial</h2>

        <select id="filtroMes" class="filtro">
            <option value="all">Ver todo</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>

        <div id="historialLista" class="lista-historial"></div>
    </section>

</div>

<script>
const API_GET = "/.netlify/functions/getPedidos";

/* COLORES */
function getColorClase(estado, tipo) {
    if (tipo === "CorreoEnviado") {
        if (estado === "CONFIRMADO") return "verde";
        if (estado === "ENVIADO SIN CONFIRMAR") return "amarillo";
        return "rojo";
    }

    if (tipo === "Sublimado" || tipo === "Costura") {
        if (estado === "TERMINADO") return "verde";
        if (estado === "EN PROCESO") return "amarillo";
        return "rojo";
    }

    if (tipo === "Entrega") {
        if (estado === "ENTREGADO") return "verde";
        if (estado === "MOTORIZADO SOLICITADO" || estado === "EN RUTA") return "amarillo";
        if (estado === "ANULADO") return "gris";
        return "rojo";
    }

    return "rojo";
}

/* CARGAR TODO */
let pedidosGlobal = [];

async function cargarPedidos() {
    const res = await fetch(API_GET);
    pedidosGlobal = await res.json();

    const pendientes = pedidosGlobal.filter(p => p.Entrega !== "ENTREGADO" && p.Entrega !== "ANULADO");
    const historial = pedidosGlobal.filter(p => p.Entrega === "ENTREGADO" || p.Entrega === "ANULADO");

    renderPendientes(pendientes);
    renderHistorial(historial);
}

/* ---------------------- */
/* TARJETAS PENDIENTES    */
/* ---------------------- */
function renderPendientes(lista) {
    const cont = document.getElementById("pendientesLista");
    cont.innerHTML = "";

    lista.forEach(p => {
        const div = document.createElement("div");
        div.className = "tarjeta";

        div.innerHTML = `
            <img src="${p.Imagen}">

            <div class="item"><span class="titulo">Pedido:</span> ${p.NoPedido}</div>
            <div class="item"><span class="titulo">Medidas (Anch x Alt):</span> ${p.Ancho} x ${p.Alto} cm</div>
            <div class="item"><span class="titulo">Fecha Pedido:</span> ${p.Fecha}</div>

            <div class="item">
                <span class="titulo">Correo:</span>
                <span class="estado ${getColorClase(p.CorreoEnviado, "CorreoEnviado")}">
                    ${p.CorreoEnviado}
                </span>
            </div>

            <div class="item">
                <span class="titulo">Sublimado:</span>
                <span class="estado ${getColorClase(p.Sublimado, "Sublimado")}">
                    ${p.Sublimado}
                </span>
            </div>

            <div class="item">
                <span class="titulo">Costura:</span>
                <span class="estado ${getColorClase(p.Costura, "Costura")}">
                    ${p.Costura}
                </span>
            </div>

            <div class="item">
                <span class="titulo">Entrega:</span>
                <span class="estado ${getColorClase(p.Entrega, "Entrega")}">
                    ${p.Entrega}
                </span>
            </div>

            <div class="item"><span class="titulo">Nombre:</span> ${p.Nombre}</div>
            <div class="item"><span class="titulo">DNI/RUC:</span> ${p.Dni}</div>
            <div class="item"><span class="titulo">Teléfono:</span> ${p.Telefono}</div>
            <div class="item"><span class="titulo">Dirección:</span> ${p.Direccion}</div>
            <div class="item"><span class="titulo">Agencia:</span> ${p.Agencia}</div>

            <div class="item"><span class="titulo">Especificaciones:</span> ${p.Especificaciones}</div>
            <div class="item"><span class="titulo">Observaciones:</span> ${p.Observaciones}</div>
        `;

        cont.appendChild(div);
    });
}

/* ---------------------- */
/* HISTORIAL CON FILTRO   */
/* ---------------------- */
function normalizarFechaLatina(fechaStr) {
    if (!fechaStr) return null;

    fechaStr = fechaStr.trim();

    // Detecta formato DD/MM/YYYY
    if (fechaStr.includes("/")) {
        const [d, m, y] = fechaStr.split("/");
        return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    // Si ya es ISO, cortar a 10 caracteres
    return fechaStr.substring(0, 10);
}

function renderHistorial(lista) {
    const cont = document.getElementById("historialLista");
    cont.innerHTML = "";

    const mes = document.getElementById("filtroMes").value;

    const filtrado = lista.filter(p => {
    if (mes === "all") return true;
    if (!p.FechaEntrega) return false;

    // Normalizar
    const fechaISO = normalizarFechaLatina(p.FechaEntrega);

    if (!fechaISO) return false;

    const fechaObj = new Date(fechaISO);

    if (isNaN(fechaObj)) return false;

    const m = fechaObj.getMonth() + 1;
    return m == mes;
});

    filtrado.forEach(p => {
        const div = document.createElement("div");
        div.className = "mini-card";

        div.innerHTML = `
            <img src="${p.Imagen}" class="mini-img">
            <div class="mini-info">
                <div><span class="mini-label">Nombre:</span> ${p.Nombre}</div>
                <div><span class="mini-label">Agencia:</span> ${p.Agencia}</div>
                <div><span class="mini-label">Fecha Entrega:</span> ${p.FechaEntrega}</div>
                <div><span class="estado ${getColorClase(p.Entrega, "Entrega")}">${p.Entrega}</span></div>
            </div>
        `;

        cont.appendChild(div);
    });
}

document.getElementById("filtroMes").addEventListener("change", () => {
    const historial = pedidosGlobal.filter(p =>
        p.Entrega === "ENTREGADO" || p.Entrega === "ANULADO"
    );
    renderHistorial(historial);
});

/* ---------------------- */
cargarPedidos();
</script>

</body>
</html>
